# 部署后功能缺失排查指南

## 问题现象
- ✅ 本地运行：所有功能正常
- ❌ 部署后：语言切换按钮和PDF工具卡片不见了

---

## 🎯 核心问题：CORS错误导致JavaScript执行失败

### 根本原因
在 `vite.config.ts` 中有错误的 `external` 配置，导致浏览器尝试加载 `node:module`，触发CORS错误。

### 已修复内容
- ✅ 移除了 `external: [/^node:*/]` 配置
- ✅ 重新构建了项目

---

## 📋 完整验证流程

### 步骤1: 确认本地构建正确

```bash
# 运行构建
npm run build

# 本地预览构建结果
npm run preview
```

访问：`http://localhost:4173`
- 检查语言切换按钮是否显示
- 检查PDF工具卡片是否显示
- 按F12查看Console是否有错误

---

### 步骤2: 部署最新版本

#### 方法A：Git自动部署（推荐）

```bash
git add .
git commit -m "fix: 移除错误的external配置，修复CORS错误"
git push
```

#### 方法B：手动部署

1. 登录 Netlify Dashboard
2. 进入站点 `pdf.voguegale.com`
3. Deploys → Deploy manually
4. 拖拽整个 `dist` 文件夹上传

---

### 步骤3: 清除所有缓存（关键！）

#### A. Netlify CDN缓存

1. **Netlify Dashboard** → 您的站点
2. **Deploys** → **Trigger deploy** → **Clear cache and deploy site**
3. 等待部署完成（约1-2分钟）

#### B. 浏览器缓存

1. **完全关闭浏览器**（所有窗口）
2. 重新打开浏览器
3. 按 `Ctrl + Shift + N` 打开无痕窗口
4. 访问 `https://pdf.voguegale.com`

---

### 步骤4: 验证部署结果

#### 检查Network（最重要）

1. 按 `F12` 打开开发者工具
2. 切换到 **Network** 标签
3. 刷新页面 (`F5`)

✅ **正常状态应该是**：
- `main-*.js` - 状态 **200**，大小约 **20 KB**（不是0.0 KB）
- `LanguageSwitcher-*.js` - 状态 **200**
- **没有 `node:module` CORS错误**

❌ **异常状态**：
- `main-*.js` - 显示 **(disk cache)** 或 **0.0 kB**
- 出现 `node:module` CORS错误
- 任何红色的404或CORS错误

#### 检查Console

```javascript
// 复制以下命令到Console，查看诊断信息
console.clear();
console.log('=== 诊断信息 ===');
console.log('1. 语言切换器:', document.getElementById('language-switcher-desktop'));
console.log('2. 工具卡片数量:', document.querySelectorAll('.tool-card').length);
console.log('3. 加载的脚本:', Array.from(document.scripts).map(s => s.src.split('/').pop()));
console.log('4. CSS文件:', Array.from(document.styleSheets).map(s => s.href?.split('/').pop() || 'inline'));
```

✅ **正常输出**：
- 语言切换器: `<div>...</div>` (不是null)
- 工具卡片数量: `12` 或更多
- 加载的脚本: 包含 `main-*.js`, `LanguageSwitcher-*.js`

#### 检查页面

- ✅ 右上角显示**语言切换按钮**（地球图标）
- ✅ 页面中间显示**PDF工具卡片**（Merge PDF, Split PDF等）
- ✅ 没有弹框遮挡

---

## 🐛 常见问题和解决方案

### 问题1: Network显示所有文件都是200，但功能还是不见

**原因**: 浏览器使用了缓存的旧版本JavaScript

**解决**:
```bash
# 在Chrome/Edge中
1. Ctrl + Shift + Delete
2. 时间范围：全部时间
3. 勾选：缓存的图片和文件、Cookie和其他网站数据
4. 清除数据
5. 完全关闭浏览器
6. 重新打开无痕窗口访问
```

---

### 问题2: Network显示 `main-*.js` 是 (disk cache) 或 0.0 kB

**原因**: 浏览器使用了本地缓存

**解决**:
```bash
# 强制重新加载
1. 在页面上按 Ctrl + Shift + R（硬刷新）
2. 或者在Network标签中勾选"Disable cache"
3. 刷新页面
```

---

### 问题3: Console显示 "Failed to load module: node:module"

**原因**: 旧版本的构建文件还在Netlify上

**解决**:
1. 确认本地已重新构建（`npm run build`）
2. 重新部署到Netlify
3. 清除Netlify缓存：Deploy settings → Clear cache and deploy

---

### 问题4: Netlify显示部署成功，但访问还是旧版本

**原因**: CDN缓存或DNS传播延迟

**解决**:
```bash
# 方法1: 使用版本参数访问
https://pdf.voguegale.com/?v=20251209

# 方法2: 检查Netlify部署时间
1. Netlify Dashboard → Deploys
2. 查看最新部署的时间戳
3. 确认是否是刚才部署的版本
```

---

## 🔧 终极验证命令

在无痕窗口的Console中运行：

```javascript
// 检查所有关键元素和配置
(async function() {
  console.clear();
  console.log('=== PDFToolkit 完整诊断 ===\n');
  
  // 1. 检查DOM元素
  const switcher = document.getElementById('language-switcher-desktop');
  const toolCards = document.querySelectorAll('.tool-card');
  const alertModal = document.getElementById('alert-modal');
  
  console.log('✓ 语言切换器:', switcher ? '✅ 存在' : '❌ 缺失');
  console.log('✓ 工具卡片:', toolCards.length, '个', toolCards.length > 0 ? '✅' : '❌');
  console.log('✓ Alert弹框:', alertModal?.classList.contains('hidden') ? '✅ 已隐藏' : '❌ 可见');
  
  // 2. 检查资源加载
  const scripts = Array.from(document.scripts).map(s => ({
    src: s.src.split('/').pop(),
    loaded: s.readyState || 'loaded'
  }));
  console.log('\n✓ 已加载脚本:', scripts.filter(s => s.src).length, '个');
  scripts.filter(s => s.src).forEach(s => console.log(`  - ${s.src}`));
  
  // 3. 检查CSS
  const styles = Array.from(document.styleSheets)
    .map(s => s.href?.split('/').pop() || 'inline')
    .filter(s => s !== 'inline');
  console.log('\n✓ 已加载样式:', styles.length, '个');
  styles.forEach(s => console.log(`  - ${s}`));
  
  // 4. 检查主JS文件内容
  const mainScript = Array.from(document.scripts).find(s => s.src.includes('main-'));
  if (mainScript) {
    try {
      const response = await fetch(mainScript.src);
      const text = await response.text();
      console.log('\n✓ main.js 大小:', (text.length / 1024).toFixed(2), 'KB');
      console.log('✓ 包含LanguageSwitcher:', text.includes('LanguageSwitcher') ? '✅' : '❌');
    } catch (e) {
      console.error('❌ 无法加载main.js:', e.message);
    }
  }
  
  // 5. 检查Console错误
  console.log('\n✓ 如果上面有红色错误，请截图\n');
  console.log('=== 诊断完成 ===');
})();
```

---

## 📸 需要提供的截图

如果问题依然存在，请提供：

1. **Network标签**（显示所有资源加载状态）
2. **Console标签**（显示上面诊断命令的输出）
3. **页面截图**（显示当前页面状态）
4. **Netlify部署页面**（显示最新部署时间）

---

## ✅ 验证成功标准

当看到以下所有指标都正常时，说明问题已解决：

- ✅ Network: 所有文件200状态，没有CORS错误
- ✅ Console: 没有红色错误，诊断命令显示所有✅
- ✅ 页面: 语言切换按钮可见，工具卡片可见
- ✅ 功能: 点击语言切换正常，点击工具卡片正常

---

## 🚀 快速检查清单

```
□ 1. 本地构建成功：npm run build
□ 2. 本地预览正常：npm run preview
□ 3. 已重新部署到Netlify
□ 4. 已清除Netlify CDN缓存
□ 5. 已完全关闭浏览器
□ 6. 已使用无痕窗口访问
□ 7. Network显示所有200
□ 8. Console没有错误
□ 9. 页面功能全部可见
```

全部打勾 = 问题解决！🎉

